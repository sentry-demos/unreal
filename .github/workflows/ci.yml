name: build-and-release-demo

on:
  # schedule:
  #    - cron: '0 */3 * * *' # every three hours
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  UE_VERSION: 5.6

jobs:
  build:
    name: Build
    runs-on: windows-latest

    steps:
      - name: Log in to GitHub package registry
        uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.PAT_TOKEN }}

      - name: Start Docker container
        run: |
          docker run -td `
            --name unreal `
            --volume "${{ github.workspace }}:C:\workspace" `
            --workdir C:\workspace `
            --env SENTRY_DSN="${{ secrets.SENTRY_DSN }}" `
            --env SENTRY_ORG="${{ secrets.SENTRY_ORG }}" `
            --env SENTRY_PROJECT="${{ secrets.SENTRY_PROJECT }}" `
            --env SENTRY_AUTH_TOKEN="${{ secrets.SENTRY_AUTH_TOKEN }}" `
            ghcr.io/getsentry/unreal-docker:${{ env.UE_VERSION }}

      - uses: actions/checkout@v4
        with:
          path: checkout
          submodules: recursive

      - name: Build game
        run: |
          docker exec unreal C:\UnrealEngine\Engine\Build\BatchFiles\RunUAT.bat BuildCookRun `
            -project=C:\workspace\checkout\SentryTower.uproject `
            -archivedirectory=C:\workspace\checkout\Builds `
            -platform=Win64 `
            -nop4 `
            -cook `
            -build `
            -stage `
            -prereqss `
            -package `
            -archive

      - name: Upload SentryTower
        uses: actions/upload-artifact@v4
        with:
          name: SentryTower
          path: checkout/Builds/Windows/
          retention-days: 90